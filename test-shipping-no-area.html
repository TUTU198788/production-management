<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘è´§åŠŸèƒ½æµ‹è¯• - æ— åŒºåŸŸé™åˆ¶</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #1f2937;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #059669;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-info {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .test-info h3 {
            color: #3b82f6;
            margin: 0 0 15px 0;
        }
        
        .test-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .test-info li {
            margin: 8px 0;
        }
        
        .big-button {
            background: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            width: calc(50% - 20px);
            box-sizing: border-box;
        }
        
        .big-button:hover {
            background: #047857;
        }
        
        .big-button.secondary {
            background: #3b82f6;
        }
        
        .big-button.secondary:hover {
            background: #2563eb;
        }
        
        .result {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .success {
            background: #ecfdf5;
            border: 2px solid #059669;
            color: #059669;
        }
        
        .info {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            color: #3b82f6;
        }
        
        .warning {
            background: #fffbeb;
            border: 2px solid #f59e0b;
            color: #f59e0b;
        }
        
        .error {
            background: #fef2f2;
            border: 2px solid #dc2626;
            color: #dc2626;
        }
        
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .inventory-table th,
        .inventory-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .inventory-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .inventory-table tr:hover {
            background: #f9fafb;
        }
        
        .spec-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .spec-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .spec-areas {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }
        
        .number-cell {
            text-align: right;
            font-weight: 500;
        }
        
        .highlight {
            background: #fef3c7 !important;
            border-left: 4px solid #f59e0b;
        }
        
        .data-summary {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸšš å‘è´§åŠŸèƒ½æµ‹è¯• - æ— åŒºåŸŸé™åˆ¶</h1>
        
        <div class="test-info">
            <h3>ğŸ¯ å‘è´§åŠŸèƒ½æ”¹è¿›è¯´æ˜</h3>
            <ul>
                <li><strong>ç§»é™¤åŒºåŸŸé™åˆ¶</strong>ï¼šä¸å†éœ€è¦é€‰æ‹©å·¥åœ°åŒºåŸŸ</li>
                <li><strong>æ€»åº“å­˜å‘è´§</strong>ï¼šç›´æ¥ä»æ‰€æœ‰åº“å­˜ä¸­é€‰æ‹©è§„æ ¼å‘è´§</li>
                <li><strong>è§„æ ¼åˆå¹¶</strong>ï¼šç›¸åŒè§„æ ¼çš„åº“å­˜è‡ªåŠ¨åˆå¹¶æ˜¾ç¤º</li>
                <li><strong>æ™ºèƒ½åˆ†é…</strong>ï¼šå‘è´§æ—¶è‡ªåŠ¨ä»å¤šä¸ªåŒºåŸŸçš„åº“å­˜ä¸­åˆ†é…</li>
                <li><strong>åŒºåŸŸæ˜¾ç¤º</strong>ï¼šåœ¨è§„æ ¼ä¸‹æ–¹æ˜¾ç¤ºæ¶‰åŠçš„åŒºåŸŸä¿¡æ¯</li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <button class="big-button" onclick="loadInventoryData()">
                ğŸ“Š åŠ è½½åº“å­˜æ•°æ®
            </button>
            
            <button class="big-button secondary" onclick="openShippingModal()">
                ğŸšš æ‰“å¼€å‘è´§ç•Œé¢
            </button>
        </div>
        
        <div class="data-summary" id="inventorySummary" style="display: none;">
            <h4>ğŸ“‹ åº“å­˜ç»Ÿè®¡</h4>
            <div class="summary-grid" id="summaryGrid">
                <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <div id="inventoryTable" style="display: none;">
            <h4>ğŸ“¦ å¯å‘è´§åº“å­˜æ˜ç»†</h4>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>è§„æ ¼å‹å·</th>
                        <th>å¯å‘è´§æ•°é‡</th>
                        <th>æ¶‰åŠåŒºåŸŸ</th>
                        <th>åˆè®¡ç±³æ•°</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- åº“å­˜æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </tbody>
            </table>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const result = document.createElement('div');
            result.className = 'result ' + type;
            result.innerHTML = message;
            resultsDiv.appendChild(result);
        }
        
        function loadInventoryData() {
            addResult('ğŸ” åŠ è½½åº“å­˜æ•°æ®...', 'info');
            
            const productionData = localStorage.getItem('productionData');
            if (!productionData) {
                addResult('âŒ æ²¡æœ‰æ‰¾åˆ°ç”Ÿäº§æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', 'warning');
                generateMockInventory();
                return;
            }
            
            try {
                const data = JSON.parse(productionData);
                processInventoryData(data);
                addResult(`âœ… æˆåŠŸåŠ è½½åº“å­˜æ•°æ®`, 'success');
            } catch (error) {
                addResult(`âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š${error.message}`, 'error');
                generateMockInventory();
            }
        }
        
        function processInventoryData(data) {
            // ç­›é€‰å‡ºå¯å‘è´§çš„é¡¹ç›®
            const availableItems = data.filter(item =>
                item.produced > item.shipped &&
                item.status !== 'planned'
            );
            
            if (availableItems.length === 0) {
                addResult('ğŸ“¦ æš‚æ— å¯å‘è´§é¡¹ç›®', 'info');
                return;
            }
            
            // æŒ‰è§„æ ¼åˆå¹¶åº“å­˜
            const mergedInventory = mergeInventoryBySpec(availableItems);
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            showInventorySummary(mergedInventory, availableItems);
            
            // æ˜¾ç¤ºåº“å­˜è¡¨æ ¼
            showInventoryTable(mergedInventory);
            
            addResult(`ğŸ“Š å…± ${mergedInventory.length} ç§è§„æ ¼å¯å‘è´§`, 'success');
        }
        
        function mergeInventoryBySpec(items) {
            const specMap = new Map();

            items.forEach(item => {
                const spec = item.spec;
                const available = item.produced - item.shipped;

                if (available > 0) {
                    if (specMap.has(spec)) {
                        const existing = specMap.get(spec);
                        existing.totalAvailable += available;
                        existing.areas.add(item.area);
                        existing.items.push(item);
                    } else {
                        specMap.set(spec, {
                            spec: spec,
                            totalAvailable: available,
                            areas: new Set([item.area]),
                            items: [item]
                        });
                    }
                }
            });

            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            return Array.from(specMap.values()).sort((a, b) => {
                // æŒ‰å‹å·æ’åºï¼ˆH80, H100ç­‰ï¼‰
                const typeA = a.spec.match(/^(H\\d+)/)?.[1] || 'Z';
                const typeB = b.spec.match(/^(H\\d+)/)?.[1] || 'Z';
                
                if (typeA !== typeB) {
                    return typeA.localeCompare(typeB);
                }
                
                // åŒå‹å·å†…æŒ‰è§„æ ¼åç§°æ’åº
                return a.spec.localeCompare(b.spec);
            });
        }
        
        function showInventorySummary(mergedInventory, originalItems) {
            const summaryDiv = document.getElementById('inventorySummary');
            const summaryGrid = document.getElementById('summaryGrid');
            
            const totalSpecs = mergedInventory.length;
            const totalQuantity = mergedInventory.reduce((sum, item) => sum + item.totalAvailable, 0);
            const totalAreas = new Set(originalItems.map(item => item.area)).size;
            
            // æŒ‰å‹å·ç»Ÿè®¡
            const typeStats = {};
            mergedInventory.forEach(item => {
                const typeMatch = item.spec.match(/^(H\\d+)/);
                const type = typeMatch ? typeMatch[1] : 'å…¶ä»–';
                
                if (!typeStats[type]) {
                    typeStats[type] = { specs: 0, quantity: 0 };
                }
                typeStats[type].specs++;
                typeStats[type].quantity += item.totalAvailable;
            });
            
            let summaryHTML = `
                <div class="summary-item">
                    <div class="summary-label">å¯å‘è´§è§„æ ¼</div>
                    <div class="summary-value">${totalSpecs} ç§</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å¯å‘è´§æ€»é‡</div>
                    <div class="summary-value">${totalQuantity.toLocaleString()} æ ¹</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ¶‰åŠåŒºåŸŸ</div>
                    <div class="summary-value">${totalAreas} ä¸ª</div>
                </div>
            `;
            
            // æ·»åŠ å‹å·ç»Ÿè®¡
            Object.keys(typeStats).sort().forEach(type => {
                const stats = typeStats[type];
                summaryHTML += `
                    <div class="summary-item">
                        <div class="summary-label">${type} å‹å·</div>
                        <div class="summary-value">${stats.specs}ç§ / ${stats.quantity.toLocaleString()}æ ¹</div>
                    </div>
                `;
            });
            
            summaryGrid.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
        }
        
        function showInventoryTable(mergedInventory) {
            const tableDiv = document.getElementById('inventoryTable');
            const tableBody = document.getElementById('inventoryTableBody');
            
            let tableHTML = '';
            mergedInventory.forEach(item => {
                const areasText = Array.from(item.areas).join(', ');
                const meters = calculateMeters(item.spec, item.totalAvailable);
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="spec-info">
                                <div class="spec-name">${item.spec}</div>
                                <div class="spec-areas">åº“å­˜åˆ†å¸ƒ: ${areasText}</div>
                            </div>
                        </td>
                        <td class="number-cell">${item.totalAvailable.toLocaleString()} æ ¹</td>
                        <td>${areasText}</td>
                        <td class="number-cell">${meters.toFixed(1)} m</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            tableDiv.style.display = 'block';
        }
        
        function calculateMeters(spec, quantity) {
            const match = spec.match(/^(H\\d+)-(\\d+)mm$/);
            if (match) {
                const length = parseInt(match[2]) / 1000; // è½¬æ¢ä¸ºç±³
                return quantity * length;
            }
            return 0;
        }
        
        function generateMockInventory() {
            const mockData = [
                { spec: 'H80-1200mm', totalAvailable: 150, areas: new Set(['C1', 'C2']) },
                { spec: 'H80-1400mm', totalAvailable: 200, areas: new Set(['C1', 'E3']) },
                { spec: 'H100-1200mm', totalAvailable: 120, areas: new Set(['D6']) },
                { spec: 'H100-1400mm', totalAvailable: 180, areas: new Set(['A14', 'E3']) },
                { spec: 'H100-1600mm', totalAvailable: 90, areas: new Set(['C2', 'D6']) }
            ];
            
            showInventorySummary(mockData, []);
            showInventoryTable(mockData);
            addResult('ğŸ“Š ä½¿ç”¨æ¨¡æ‹Ÿåº“å­˜æ•°æ®', 'info');
        }
        
        function openShippingModal() {
            addResult('ğŸšš åœ¨ä¸»ç³»ç»Ÿä¸­æ‰“å¼€å‘è´§ç•Œé¢...', 'info');
            window.open('index.html', '_blank');
            addResult('ğŸ’¡ æç¤ºï¼šåœ¨ä¸»ç³»ç»Ÿä¸­ç‚¹å‡»"å‘è´§"æŒ‰é’®ï¼Œç°åœ¨æ— éœ€é€‰æ‹©åŒºåŸŸå³å¯ç›´æ¥åŠ è½½æ‰€æœ‰å¯å‘è´§é¡¹ç›®', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.onload = function() {
            setTimeout(loadInventoryData, 500);
        };
    </script>
</body>
</html>
