<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘è´§è®°å½•åˆ é™¤åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #1f2937;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .demo-info {
            background: #fef2f2;
            border: 2px solid #dc2626;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .demo-info h3 {
            color: #dc2626;
            margin: 0 0 15px 0;
        }
        
        .test-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h4 {
            color: #374151;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .test-result {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #ecfdf5;
            border: 1px solid #059669;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #059669;
        }
        
        .stat-label {
            font-size: 12px;
            color: #047857;
            margin-top: 5px;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning-box h5 {
            color: #92400e;
            margin: 0 0 10px 0;
        }
        
        .test-steps {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-steps h5 {
            color: #1e40af;
            margin: 0 0 15px 0;
        }
        
        .test-steps ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .test-steps li {
            margin-bottom: 8px;
            color: #1f2937;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ—‘ï¸ å‘è´§è®°å½•åˆ é™¤åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="demo-info">
            <h3>âš ï¸ é‡è¦è¯´æ˜</h3>
            <ul>
                <li><strong>åˆ é™¤å½±å“</strong>ï¼šåˆ é™¤å‘è´§è®°å½•ä¼šåŒæ—¶è°ƒæ•´åº“å­˜ï¼Œå¢åŠ å¯å‘è´§æ•°é‡</li>
                <li><strong>æ•°æ®åŒæ­¥</strong>ï¼šåˆ é™¤æ“ä½œä¼šåŒæ­¥æ›´æ–°åŸå§‹æ•°æ®å’Œå†å²è®°å½•</li>
                <li><strong>ä¸å¯æ¢å¤</strong>ï¼šåˆ é™¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ</li>
                <li><strong>åº“å­˜è°ƒæ•´</strong>ï¼šåˆ é™¤åï¼Œå¯¹åº”è§„æ ¼çš„å·²å‘è´§æ•°é‡ä¼šå‡å°‘ï¼Œåº“å­˜ä¼šå¢åŠ </li>
            </ul>
        </div>
        
        <div class="test-section">
            <h4>ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€</h4>
            <div class="stats-grid" id="currentStats">
                <div class="stat-card">
                    <div class="stat-value" id="totalItems">-</div>
                    <div class="stat-label">æ€»æ•°æ®æ¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalShipped">-</div>
                    <div class="stat-label">æ€»å·²å‘è´§æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="historyRecords">-</div>
                    <div class="stat-label">å†å²è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="shippingRecords">-</div>
                    <div class="stat-label">åŸå§‹å‘è´§è®°å½•æ•°</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h4>ğŸ” æ•°æ®æ£€æŸ¥</h4>
            <button class="btn btn-primary" onclick="checkCurrentData()">
                <i class="fas fa-search"></i>
                æ£€æŸ¥å½“å‰æ•°æ®
            </button>
            <button class="btn btn-success" onclick="checkConsistency()">
                <i class="fas fa-balance-scale"></i>
                æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
            </button>
            <button class="btn btn-warning" onclick="simulateDelete()">
                <i class="fas fa-trash"></i>
                æ¨¡æ‹Ÿåˆ é™¤æµ‹è¯•
            </button>
            <div class="test-result" id="checkResult"></div>
        </div>
        
        <div class="test-section">
            <h4>ğŸ§ª åˆ é™¤åŠŸèƒ½æµ‹è¯•</h4>
            
            <div class="test-steps">
                <h5>æµ‹è¯•æ­¥éª¤ï¼š</h5>
                <ol>
                    <li>ç‚¹å‡»"æ£€æŸ¥å½“å‰æ•°æ®"æŸ¥çœ‹åˆ é™¤å‰çš„çŠ¶æ€</li>
                    <li>åœ¨ä¸»ç³»ç»Ÿä¸­æ‰“å¼€"å‘è´§å†å²"</li>
                    <li>é€‰æ‹©ä¸€æ¡å‘è´§è®°å½•ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</li>
                    <li>åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ï¼Œç‚¹å‡»"åˆ é™¤å‘è´§è®°å½•"</li>
                    <li>ç¡®è®¤åˆ é™¤åï¼Œè¿”å›æ­¤é¡µé¢ç‚¹å‡»"æ£€æŸ¥åˆ é™¤åçŠ¶æ€"</li>
                    <li>éªŒè¯åº“å­˜æ˜¯å¦æ­£ç¡®è°ƒæ•´</li>
                </ol>
            </div>
            
            <div class="warning-box">
                <h5>âš ï¸ æµ‹è¯•æ³¨æ„äº‹é¡¹</h5>
                <ul>
                    <li>å»ºè®®å…ˆå¤‡ä»½æ•°æ®æˆ–åœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œ</li>
                    <li>åˆ é™¤æ“ä½œä¼šçœŸå®å½±å“åº“å­˜æ•°æ®</li>
                    <li>å¦‚æœæµ‹è¯•å‡ºç°é—®é¢˜ï¼Œå¯ä»¥åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½æ•°æ®</li>
                </ul>
            </div>
            
            <button class="btn btn-primary" onclick="openMainSystem()">
                <i class="fas fa-external-link-alt"></i>
                æ‰“å¼€ä¸»ç³»ç»Ÿæµ‹è¯•
            </button>
            <button class="btn btn-success" onclick="checkAfterDelete()">
                <i class="fas fa-check"></i>
                æ£€æŸ¥åˆ é™¤åçŠ¶æ€
            </button>
            <button class="btn btn-warning" onclick="resetTestData()">
                <i class="fas fa-undo"></i>
                é‡ç½®æµ‹è¯•æ•°æ®
            </button>
        </div>
        
        <div class="test-section">
            <h4>ğŸ“‹ æµ‹è¯•ç»“æœ</h4>
            <div class="test-result" id="testResult"></div>
        </div>
    </div>

    <script>
        let testData = null;
        let beforeDeleteStats = null;
        
        function log(message, containerId = 'testResult') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
        }
        
        function updateStats() {
            if (!testData) return;
            
            const totalItems = testData.length;
            let totalShipped = 0;
            let shippingRecords = 0;
            
            testData.forEach(item => {
                totalShipped += item.shipped || 0;
                if (item.shippingRecords) {
                    shippingRecords += item.shippingRecords.length;
                }
            });
            
            const historyRecords = JSON.parse(localStorage.getItem('shippingHistory') || '[]').length;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalShipped').textContent = totalShipped.toLocaleString();
            document.getElementById('historyRecords').textContent = historyRecords;
            document.getElementById('shippingRecords').textContent = shippingRecords;
        }
        
        function checkCurrentData() {
            log('=== æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€ ===', 'checkResult');
            
            try {
                const savedData = localStorage.getItem('productionData');
                if (!savedData) {
                    log('âŒ æ²¡æœ‰æ‰¾åˆ°æœ¬åœ°æ•°æ®', 'checkResult');
                    return;
                }
                
                testData = JSON.parse(savedData);
                log(`âœ… åŠ è½½äº† ${testData.length} æ¡æ•°æ®`, 'checkResult');
                
                // ç»Ÿè®¡å‘è´§ç›¸å…³æ•°æ®
                let totalShipped = 0;
                let itemsWithShipping = 0;
                let totalShippingRecords = 0;
                
                testData.forEach(item => {
                    totalShipped += item.shipped || 0;
                    if (item.shippingRecords && item.shippingRecords.length > 0) {
                        itemsWithShipping++;
                        totalShippingRecords += item.shippingRecords.length;
                    }
                });
                
                const historyRecords = JSON.parse(localStorage.getItem('shippingHistory') || '[]');
                
                log(`ğŸ“Š æ•°æ®ç»Ÿè®¡:`, 'checkResult');
                log(`   æ€»å·²å‘è´§æ•°é‡: ${totalShipped}`, 'checkResult');
                log(`   æœ‰å‘è´§è®°å½•çš„é¡¹ç›®: ${itemsWithShipping}`, 'checkResult');
                log(`   åŸå§‹å‘è´§è®°å½•æ•°: ${totalShippingRecords}`, 'checkResult');
                log(`   å†å²è®°å½•æ•°: ${historyRecords.length}`, 'checkResult');
                
                // ä¿å­˜åˆ é™¤å‰çš„çŠ¶æ€
                beforeDeleteStats = {
                    totalShipped,
                    itemsWithShipping,
                    totalShippingRecords,
                    historyRecords: historyRecords.length
                };
                
                updateStats();
                
            } catch (error) {
                log(`âŒ æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'checkResult');
            }
        }
        
        function checkConsistency() {
            if (!testData) {
                log('âŒ è¯·å…ˆæ£€æŸ¥å½“å‰æ•°æ®', 'checkResult');
                return;
            }
            
            log('=== æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ ===', 'checkResult');
            
            const historyRecords = JSON.parse(localStorage.getItem('shippingHistory') || '[]');
            
            // è®¡ç®—å†å²è®°å½•ä¸­çš„æ€»å‘è´§é‡
            let historyTotalQuantity = 0;
            historyRecords.forEach(record => {
                historyTotalQuantity += record.totalQuantity || 0;
            });
            
            // è®¡ç®—åŸå§‹æ•°æ®ä¸­çš„æ€»å‘è´§é‡
            let originalTotalShipped = 0;
            testData.forEach(item => {
                originalTotalShipped += item.shipped || 0;
            });
            
            log(`å†å²è®°å½•æ€»å‘è´§é‡: ${historyTotalQuantity}`, 'checkResult');
            log(`åŸå§‹æ•°æ®æ€»å‘è´§é‡: ${originalTotalShipped}`, 'checkResult');
            
            if (Math.abs(historyTotalQuantity - originalTotalShipped) < 10) {
                log('âœ… æ•°æ®åŸºæœ¬ä¸€è‡´', 'checkResult');
            } else {
                log('âš ï¸ æ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼Œå·®å€¼è¾ƒå¤§', 'checkResult');
            }
        }
        
        function simulateDelete() {
            log('=== æ¨¡æ‹Ÿåˆ é™¤æ“ä½œ ===', 'checkResult');
            log('è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿæ“ä½œï¼Œä¸ä¼šçœŸå®åˆ é™¤æ•°æ®', 'checkResult');
            log('çœŸå®åˆ é™¤è¯·åœ¨ä¸»ç³»ç»Ÿä¸­è¿›è¡Œ', 'checkResult');
            
            if (!testData) {
                log('âŒ è¯·å…ˆæ£€æŸ¥å½“å‰æ•°æ®', 'checkResult');
                return;
            }
            
            // æ‰¾ä¸€ä¸ªæœ‰å‘è´§è®°å½•çš„é¡¹ç›®è¿›è¡Œæ¨¡æ‹Ÿ
            const itemWithShipping = testData.find(item => 
                item.shippingRecords && item.shippingRecords.length > 0
            );
            
            if (itemWithShipping) {
                const shippingRecord = itemWithShipping.shippingRecords[0];
                log(`æ¨¡æ‹Ÿåˆ é™¤é¡¹ç›®: ${itemWithShipping.spec}`, 'checkResult');
                log(`åˆ é™¤å‰å·²å‘è´§: ${itemWithShipping.shipped}`, 'checkResult');
                log(`è¦åˆ é™¤çš„æ•°é‡: ${shippingRecord.quantity}`, 'checkResult');
                log(`åˆ é™¤åå·²å‘è´§: ${itemWithShipping.shipped - shippingRecord.quantity}`, 'checkResult');
                log('ğŸ’¡ åœ¨ä¸»ç³»ç»Ÿä¸­æ‰§è¡ŒçœŸå®åˆ é™¤æ¥éªŒè¯åŠŸèƒ½', 'checkResult');
            } else {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°å¯åˆ é™¤çš„å‘è´§è®°å½•', 'checkResult');
            }
        }
        
        function checkAfterDelete() {
            log('=== æ£€æŸ¥åˆ é™¤åçŠ¶æ€ ===', 'testResult');
            
            if (!beforeDeleteStats) {
                log('âŒ æ²¡æœ‰åˆ é™¤å‰çš„æ•°æ®ï¼Œè¯·å…ˆæ£€æŸ¥å½“å‰æ•°æ®', 'testResult');
                return;
            }
            
            try {
                const currentData = JSON.parse(localStorage.getItem('productionData') || '[]');
                const currentHistory = JSON.parse(localStorage.getItem('shippingHistory') || '[]');
                
                let currentTotalShipped = 0;
                let currentShippingRecords = 0;
                
                currentData.forEach(item => {
                    currentTotalShipped += item.shipped || 0;
                    if (item.shippingRecords) {
                        currentShippingRecords += item.shippingRecords.length;
                    }
                });
                
                log('ğŸ“Š åˆ é™¤å‰åå¯¹æ¯”:', 'testResult');
                log(`æ€»å·²å‘è´§æ•°é‡: ${beforeDeleteStats.totalShipped} â†’ ${currentTotalShipped}`, 'testResult');
                log(`åŸå§‹å‘è´§è®°å½•æ•°: ${beforeDeleteStats.totalShippingRecords} â†’ ${currentShippingRecords}`, 'testResult');
                log(`å†å²è®°å½•æ•°: ${beforeDeleteStats.historyRecords} â†’ ${currentHistory.length}`, 'testResult');
                
                const shippedDiff = beforeDeleteStats.totalShipped - currentTotalShipped;
                const recordDiff = beforeDeleteStats.totalShippingRecords - currentShippingRecords;
                const historyDiff = beforeDeleteStats.historyRecords - currentHistory.length;
                
                if (shippedDiff > 0) {
                    log(`âœ… å·²å‘è´§æ•°é‡å‡å°‘äº† ${shippedDiff}ï¼Œåº“å­˜ç›¸åº”å¢åŠ `, 'testResult');
                }
                
                if (recordDiff > 0) {
                    log(`âœ… åŸå§‹å‘è´§è®°å½•å‡å°‘äº† ${recordDiff} æ¡`, 'testResult');
                }
                
                if (historyDiff > 0) {
                    log(`âœ… å†å²è®°å½•å‡å°‘äº† ${historyDiff} æ¡`, 'testResult');
                }
                
                if (shippedDiff === 0 && recordDiff === 0 && historyDiff === 0) {
                    log('âš ï¸ æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œå¯èƒ½åˆ é™¤æ“ä½œæœªç”Ÿæ•ˆ', 'testResult');
                }
                
                testData = currentData;
                updateStats();
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'testResult');
            }
        }
        
        function resetTestData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æµ‹è¯•æ•°æ®å—ï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼')) {
                localStorage.clear();
                log('âœ… æµ‹è¯•æ•°æ®å·²é‡ç½®', 'testResult');
                testData = null;
                beforeDeleteStats = null;
                updateStats();
            }
        }
        
        function openMainSystem() {
            window.open('index.html', '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°æ®
        window.onload = function() {
            checkCurrentData();
        };
    </script>
</body>
</html>
