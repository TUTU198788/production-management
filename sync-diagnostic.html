<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .btn.warning { background: #ffc107; color: #333; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .metric-display {
            display: inline-block;
            background: #e9ecef;
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            min-width: 120px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="diagnostic-card">
        <h1>ğŸ” æ•°æ®åŒæ­¥è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºè¯Šæ–­å’Œä¿®å¤ä¸»ç•Œé¢ç»Ÿè®¡æ˜¾ç¤ºä¸º0çš„é—®é¢˜ã€‚</p>
        <button class="btn success" onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <button class="btn warning" onclick="forceDataSync()">å¼ºåˆ¶æ•°æ®åŒæ­¥</button>
        <button class="btn danger" onclick="resetAndReload()">é‡ç½®å¹¶é‡æ–°åŠ è½½</button>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€æ¦‚è§ˆ</h2>
        <div id="statusOverview">
            <p>æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</p>
        </div>
        <button class="btn" onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ“ˆ ä¸»ç•Œé¢ç»Ÿè®¡æ•°æ®</h2>
        <div id="metricsDisplay">
            <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ—ƒï¸ æ•°æ®æºè¯¦æƒ…</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>æ•°æ®æº</th>
                    <th>è®°å½•æ•°</th>
                    <th>æœ€åä¿®æ”¹</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="dataSourceTable">
                <!-- æ•°æ®æºä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </tbody>
        </table>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ“ è¯Šæ–­æ—¥å¿—</h2>
        <div id="diagnosticLog" class="log-area">
            <!-- è¯Šæ–­æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <button class="btn warning" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('diagnosticLog');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('diagnosticLog').innerHTML = '';
        }

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            log('åˆ·æ–°ç³»ç»ŸçŠ¶æ€...', 'info');
            checkSystemStatus();
            updateMetricsDisplay();
            updateDataSourceTable();
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        function checkSystemStatus() {
            const statusDiv = document.getElementById('statusOverview');
            let statusHtml = '';

            // æ£€æŸ¥DataManager
            if (window.dataManager) {
                statusHtml += '<p class="status-good">âœ… DataManager: å·²åŠ è½½</p>';
                statusHtml += `<p>ç”Ÿäº§æ•°æ®: ${window.dataManager.data?.length || 0} æ¡</p>`;
                statusHtml += `<p>å‘è´§å†å²: ${window.dataManager.shippingHistory?.length || 0} æ¡</p>`;
                statusHtml += `<p>åŸææ–™: ${window.dataManager.materialPurchases?.length || 0} æ¡</p>`;
            } else {
                statusHtml += '<p class="status-error">âŒ DataManager: æœªåŠ è½½</p>';
            }

            // æ£€æŸ¥Dashboard
            if (window.dashboard) {
                statusHtml += '<p class="status-good">âœ… Dashboard: å·²åŠ è½½</p>';
                const metrics = window.dashboard.data;
                if (metrics && metrics.totalDemandMeters > 0) {
                    statusHtml += '<p class="status-good">âœ… ä¸»ç•Œé¢ç»Ÿè®¡: æ­£å¸¸æ˜¾ç¤º</p>';
                } else {
                    statusHtml += '<p class="status-error">âŒ ä¸»ç•Œé¢ç»Ÿè®¡: æ˜¾ç¤ºä¸º0</p>';
                }
            } else {
                statusHtml += '<p class="status-error">âŒ Dashboard: æœªåŠ è½½</p>';
            }

            // æ£€æŸ¥Firebase
            if (window.firebaseSync && window.firebaseSync.isConnected()) {
                statusHtml += '<p class="status-good">âœ… Firebase: å·²è¿æ¥</p>';
            } else {
                statusHtml += '<p class="status-warning">âš ï¸ Firebase: æœªè¿æ¥æˆ–æœªé…ç½®</p>';
            }

            statusDiv.innerHTML = statusHtml;
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateMetricsDisplay() {
            const metricsDiv = document.getElementById('metricsDisplay');
            
            if (!window.dashboard || !window.dashboard.data) {
                metricsDiv.innerHTML = '<p class="status-error">âŒ æ— æ³•è·å–ç»Ÿè®¡æ•°æ®</p>';
                return;
            }

            const data = window.dashboard.data;
            metricsDiv.innerHTML = `
                <div class="metric-display">
                    <div class="metric-value">${(data.totalDemandMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">æ€»éœ€æ±‚é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.producedMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">å·²ç”Ÿäº§é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.shippedMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">å·²å‘è´§é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.pendingMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">å¾…ç”Ÿäº§é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${data.completionRate || 0}%</div>
                    <div class="metric-label">å®Œæˆç‡</div>
                </div>
            `;
        }

        // æ›´æ–°æ•°æ®æºè¡¨æ ¼
        function updateDataSourceTable() {
            const tableBody = document.getElementById('dataSourceTable');
            let html = '';

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            const localData = localStorage.getItem('productionData');
            const localShipping = localStorage.getItem('shippingHistory');
            const localMaterial = localStorage.getItem('materialPurchases');

            // ç”Ÿäº§æ•°æ®
            if (localData) {
                try {
                    const data = JSON.parse(localData);
                    const lastModified = data.length > 0 ? Math.max(...data.map(item => item.lastModified || item.timestamp || 0)) : 0;
                    const status = data.length > 0 ? 'æ­£å¸¸' : 'ç©ºæ•°æ®';
                    html += `
                        <tr>
                            <td>ç”Ÿäº§æ•°æ® (æœ¬åœ°å­˜å‚¨)</td>
                            <td>${data.length}</td>
                            <td>${lastModified ? new Date(lastModified).toLocaleString() : 'æ— '}</td>
                            <td class="${status === 'æ­£å¸¸' ? 'status-good' : 'status-warning'}">${status}</td>
                            <td><button class="btn" onclick="reloadProductionData()">é‡æ–°åŠ è½½</button></td>
                        </tr>
                    `;
                } catch (error) {
                    html += `
                        <tr>
                            <td>ç”Ÿäº§æ•°æ® (æœ¬åœ°å­˜å‚¨)</td>
                            <td>-</td>
                            <td>-</td>
                            <td class="status-error">è§£æé”™è¯¯</td>
                            <td><button class="btn danger" onclick="clearProductionData()">æ¸…é™¤</button></td>
                        </tr>
                    `;
                }
            } else {
                html += `
                    <tr>
                        <td>ç”Ÿäº§æ•°æ® (æœ¬åœ°å­˜å‚¨)</td>
                        <td>0</td>
                        <td>-</td>
                        <td class="status-warning">æ— æ•°æ®</td>
                        <td>-</td>
                    </tr>
                `;
            }

            // DataManagerä¸­çš„æ•°æ®
            if (window.dataManager) {
                const dmData = window.dataManager.data || [];
                const status = dmData.length > 0 ? 'æ­£å¸¸' : 'ç©ºæ•°æ®';
                html += `
                    <tr>
                        <td>ç”Ÿäº§æ•°æ® (DataManager)</td>
                        <td>${dmData.length}</td>
                        <td>-</td>
                        <td class="${status === 'æ­£å¸¸' ? 'status-good' : 'status-warning'}">${status}</td>
                        <td><button class="btn" onclick="refreshDataManager()">åˆ·æ–°</button></td>
                    </tr>
                `;
            }

            tableBody.innerHTML = html;
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        function runFullDiagnostic() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...', 'info');
            
            // 1. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            log('1. æ£€æŸ¥ç³»ç»Ÿç»„ä»¶çŠ¶æ€...', 'info');
            checkSystemStatus();
            
            // 2. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
            log('2. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§...', 'info');
            checkDataConsistency();
            
            // 3. æ£€æŸ¥ç»Ÿè®¡è®¡ç®—
            log('3. æ£€æŸ¥ç»Ÿè®¡è®¡ç®—é€»è¾‘...', 'info');
            checkStatisticsCalculation();
            
            // 4. æ›´æ–°æ˜¾ç¤º
            setTimeout(() => {
                updateMetricsDisplay();
                updateDataSourceTable();
                log('è¯Šæ–­å®Œæˆ', 'success');
            }, 1000);
        }

        // æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
        function checkDataConsistency() {
            if (!window.dataManager) {
                log('âŒ DataManagerä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§', 'error');
                return;
            }

            const localData = localStorage.getItem('productionData');
            const dmData = window.dataManager.data || [];
            
            if (!localData) {
                log('âš ï¸ æœ¬åœ°å­˜å‚¨ä¸­æ— ç”Ÿäº§æ•°æ®', 'warning');
                return;
            }

            try {
                const parsedLocal = JSON.parse(localData);
                if (parsedLocal.length !== dmData.length) {
                    log(`âš ï¸ æ•°æ®ä¸ä¸€è‡´: æœ¬åœ°å­˜å‚¨${parsedLocal.length}æ¡ï¼ŒDataManager${dmData.length}æ¡`, 'warning');
                    log('å°è¯•åŒæ­¥æ•°æ®...', 'info');
                    window.dataManager.loadFromLocalStorage();
                } else {
                    log('âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡', 'success');
                }
            } catch (error) {
                log('âŒ æœ¬åœ°å­˜å‚¨æ•°æ®è§£æå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥ç»Ÿè®¡è®¡ç®—
        function checkStatisticsCalculation() {
            if (!window.dashboard || !window.dataManager) {
                log('âŒ Dashboardæˆ–DataManagerä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥ç»Ÿè®¡è®¡ç®—', 'error');
                return;
            }

            const dataLength = window.dataManager.data?.length || 0;
            const metrics = window.dashboard.data?.totalDemandMeters || 0;

            if (dataLength > 0 && metrics === 0) {
                log('âŒ æ£€æµ‹åˆ°ç»Ÿè®¡è®¡ç®—å¼‚å¸¸ï¼šæœ‰æ•°æ®ä½†ç»Ÿè®¡ä¸º0', 'error');
                log('å°è¯•é‡æ–°è®¡ç®—ç»Ÿè®¡...', 'info');
                window.dashboard.updateMetricsFromDataManager();
                
                setTimeout(() => {
                    const newMetrics = window.dashboard.data?.totalDemandMeters || 0;
                    if (newMetrics > 0) {
                        log('âœ… ç»Ÿè®¡é‡æ–°è®¡ç®—æˆåŠŸ', 'success');
                    } else {
                        log('âŒ ç»Ÿè®¡é‡æ–°è®¡ç®—å¤±è´¥', 'error');
                    }
                }, 1000);
            } else {
                log('âœ… ç»Ÿè®¡è®¡ç®—æ£€æŸ¥é€šè¿‡', 'success');
            }
        }

        // å¼ºåˆ¶æ•°æ®åŒæ­¥
        function forceDataSync() {
            log('å¼€å§‹å¼ºåˆ¶æ•°æ®åŒæ­¥...', 'info');
            
            if (window.dataManager) {
                log('é‡æ–°åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®...', 'info');
                window.dataManager.loadFromLocalStorage();
            }
            
            if (window.dashboard) {
                log('å¼ºåˆ¶æ›´æ–°ä¸»ç•Œé¢ç»Ÿè®¡...', 'info');
                window.dashboard.updateMetricsFromDataManager();
                
                setTimeout(() => {
                    if (window.dashboard.deepDataSync) {
                        log('æ‰§è¡Œæ·±åº¦æ•°æ®åŒæ­¥...', 'info');
                        window.dashboard.deepDataSync();
                    }
                }, 1000);
            }
            
            setTimeout(() => {
                refreshStatus();
                log('å¼ºåˆ¶åŒæ­¥å®Œæˆ', 'success');
            }, 2000);
        }

        // é‡ç½®å¹¶é‡æ–°åŠ è½½
        function resetAndReload() {
            if (confirm('ç¡®å®šè¦é‡ç½®å¹¶é‡æ–°åŠ è½½å—ï¼Ÿè¿™å°†åˆ·æ–°é¡µé¢ã€‚')) {
                log('é‡ç½®å¹¶é‡æ–°åŠ è½½...', 'warning');
                location.reload();
            }
        }

        // é‡æ–°åŠ è½½ç”Ÿäº§æ•°æ®
        function reloadProductionData() {
            if (window.dataManager) {
                log('é‡æ–°åŠ è½½ç”Ÿäº§æ•°æ®...', 'info');
                window.dataManager.loadFromLocalStorage();
                setTimeout(() => {
                    refreshStatus();
                    log('ç”Ÿäº§æ•°æ®é‡æ–°åŠ è½½å®Œæˆ', 'success');
                }, 500);
            }
        }

        // åˆ·æ–°DataManager
        function refreshDataManager() {
            if (window.dataManager) {
                log('åˆ·æ–°DataManager...', 'info');
                window.dataManager.forceUpdateDashboard();
                setTimeout(() => {
                    refreshStatus();
                    log('DataManageråˆ·æ–°å®Œæˆ', 'success');
                }, 500);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('æ•°æ®åŒæ­¥è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
            setTimeout(() => {
                refreshStatus();
            }, 1000);
        });
    </script>
</body>
</html>
