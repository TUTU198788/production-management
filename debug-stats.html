<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿè®¡æ•°æ®è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .btn.warning { background: #ffc107; color: #333; }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .metric-display {
            display: inline-block;
            background: #e9ecef;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
        }
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="debug-card">
        <h1>ğŸ” ç»Ÿè®¡æ•°æ®è°ƒè¯•å·¥å…·</h1>
        <p>ä¸“é—¨ç”¨äºè°ƒè¯•ä¸»ç•Œé¢ç»Ÿè®¡æ˜¾ç¤ºä¸º0çš„é—®é¢˜</p>
        <button class="btn success" onclick="runFullDebug()">è¿è¡Œå®Œæ•´è°ƒè¯•</button>
        <button class="btn warning" onclick="forceRecalculate()">å¼ºåˆ¶é‡æ–°è®¡ç®—</button>
        <button class="btn danger" onclick="resetData()">é‡ç½®æ•°æ®</button>
        <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="debug-card">
        <h2>ğŸ“Š å½“å‰ç»Ÿè®¡æ•°æ®</h2>
        <div id="currentStats">
            <!-- å½“å‰ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <button class="btn" onclick="refreshStats()">åˆ·æ–°ç»Ÿè®¡</button>
    </div>

    <div class="debug-card">
        <h2>ğŸ—ƒï¸ æ•°æ®æºåˆ†æ</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>æ•°æ®æº</th>
                    <th>çŠ¶æ€</th>
                    <th>è®°å½•æ•°</th>
                    <th>è¯¦ç»†ä¿¡æ¯</th>
                </tr>
            </thead>
            <tbody id="dataSourceAnalysis">
                <!-- æ•°æ®æºåˆ†æå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </tbody>
        </table>
    </div>

    <div class="debug-card">
        <h2>ğŸ”¬ è®¡ç®—è¿‡ç¨‹åˆ†æ</h2>
        <div id="calculationAnalysis">
            <!-- è®¡ç®—è¿‡ç¨‹åˆ†æå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <button class="btn" onclick="analyzeCalculation()">åˆ†æè®¡ç®—è¿‡ç¨‹</button>
    </div>

    <div class="debug-card">
        <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
        <div id="debugLog" class="log-area">
            <!-- è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('debugLog');
            const color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logArea.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // åˆ·æ–°ç»Ÿè®¡æ˜¾ç¤º
        function refreshStats() {
            const statsDiv = document.getElementById('currentStats');
            
            if (!window.dashboard) {
                statsDiv.innerHTML = '<p class="status-error">âŒ DashboardæœªåŠ è½½</p>';
                return;
            }

            const data = window.dashboard.data || {};
            statsDiv.innerHTML = `
                <div class="metric-display">
                    <div class="metric-value">${(data.totalDemandMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">æ€»éœ€æ±‚é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.producedMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">å·²ç”Ÿäº§é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.pendingMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">å¾…ç”Ÿäº§é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${data.completionRate || 0}%</div>
                    <div class="metric-label">å®Œæˆç‡</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.shippedMeters || 0).toFixed(1)}</div>
                    <div class="metric-label">å·²å‘è´§é‡ (ç±³)</div>
                </div>
                <div class="metric-display">
                    <div class="metric-value">${(data.materialTons || 0).toFixed(1)}</div>
                    <div class="metric-label">åŸææ–™ (å¨)</div>
                </div>
            `;
        }

        // åˆ†ææ•°æ®æº
        function analyzeDataSources() {
            const tableBody = document.getElementById('dataSourceAnalysis');
            let html = '';

            // æ£€æŸ¥ window.dataManager
            if (window.dataManager) {
                const data = window.dataManager.data || [];
                const status = data.length > 0 ? 'æ­£å¸¸' : 'ç©ºæ•°æ®';
                html += `
                    <tr>
                        <td>window.dataManager.data</td>
                        <td class="${status === 'æ­£å¸¸' ? 'status-good' : 'status-warning'}">${status}</td>
                        <td>${data.length}</td>
                        <td>ç”Ÿäº§æ•°æ®ä¸»æ•°ç»„</td>
                    </tr>
                `;

                // æ£€æŸ¥å‘è´§å†å²
                const shipping = window.dataManager.shippingHistory || [];
                html += `
                    <tr>
                        <td>window.dataManager.shippingHistory</td>
                        <td class="${shipping.length > 0 ? 'status-good' : 'status-warning'}">${shipping.length > 0 ? 'æ­£å¸¸' : 'ç©ºæ•°æ®'}</td>
                        <td>${shipping.length}</td>
                        <td>å‘è´§å†å²æ•°æ®</td>
                    </tr>
                `;

                // æ£€æŸ¥åŸææ–™é‡‡è´­
                const materials = window.dataManager.materialPurchases || [];
                html += `
                    <tr>
                        <td>window.dataManager.materialPurchases</td>
                        <td class="${materials.length > 0 ? 'status-good' : 'status-warning'}">${materials.length > 0 ? 'æ­£å¸¸' : 'ç©ºæ•°æ®'}</td>
                        <td>${materials.length}</td>
                        <td>åŸææ–™é‡‡è´­æ•°æ®</td>
                    </tr>
                `;
            } else {
                html += `
                    <tr>
                        <td>window.dataManager</td>
                        <td class="status-error">ä¸å­˜åœ¨</td>
                        <td>-</td>
                        <td>æ•°æ®ç®¡ç†å™¨æœªåŠ è½½</td>
                    </tr>
                `;
            }

            // æ£€æŸ¥ window.dashboard
            if (window.dashboard) {
                const dashData = window.dashboard.data || {};
                html += `
                    <tr>
                        <td>window.dashboard.data</td>
                        <td class="${Object.keys(dashData).length > 0 ? 'status-good' : 'status-warning'}">å·²åŠ è½½</td>
                        <td>${Object.keys(dashData).length} ä¸ªå±æ€§</td>
                        <td>ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ®</td>
                    </tr>
                `;
            } else {
                html += `
                    <tr>
                        <td>window.dashboard</td>
                        <td class="status-error">ä¸å­˜åœ¨</td>
                        <td>-</td>
                        <td>ä»ªè¡¨æ¿æœªåŠ è½½</td>
                    </tr>
                `;
            }

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            const localData = localStorage.getItem('productionData');
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    html += `
                        <tr>
                            <td>localStorage.productionData</td>
                            <td class="status-good">æ­£å¸¸</td>
                            <td>${parsed.length}</td>
                            <td>æœ¬åœ°å­˜å‚¨çš„ç”Ÿäº§æ•°æ®</td>
                        </tr>
                    `;
                } catch (error) {
                    html += `
                        <tr>
                            <td>localStorage.productionData</td>
                            <td class="status-error">è§£æé”™è¯¯</td>
                            <td>-</td>
                            <td>æ•°æ®æ ¼å¼å¼‚å¸¸</td>
                        </tr>
                    `;
                }
            } else {
                html += `
                    <tr>
                        <td>localStorage.productionData</td>
                        <td class="status-warning">ä¸å­˜åœ¨</td>
                        <td>0</td>
                        <td>æœ¬åœ°å­˜å‚¨ä¸ºç©º</td>
                    </tr>
                `;
            }

            tableBody.innerHTML = html;
        }

        // åˆ†æè®¡ç®—è¿‡ç¨‹
        function analyzeCalculation() {
            const analysisDiv = document.getElementById('calculationAnalysis');
            
            if (!window.dataManager || !window.dataManager.data) {
                analysisDiv.innerHTML = '<p class="status-error">âŒ æ— æ³•åˆ†æï¼šDataManageræˆ–æ•°æ®ä¸å­˜åœ¨</p>';
                return;
            }

            const data = window.dataManager.data;
            log(`å¼€å§‹åˆ†æè®¡ç®—è¿‡ç¨‹ï¼Œæ•°æ®æ¡æ•°: ${data.length}`, 'info');

            let html = '<h3>è®¡ç®—è¿‡ç¨‹è¯¦ç»†åˆ†æ</h3>';
            
            // æ¨¡æ‹Ÿä¸»ç•Œé¢çš„è®¡ç®—é€»è¾‘
            let totalDemandMeters = 0;
            let producedMeters = 0;
            let calculationDetails = [];

            data.forEach((item, index) => {
                if (index < 10) { // åªæ˜¾ç¤ºå‰10æ¡çš„è¯¦ç»†è®¡ç®—
                    const length = extractLengthFromSpec(item.spec);
                    const demandMeter = item.planned * length / 1000;
                    const producedMeter = item.produced * length / 1000;
                    
                    totalDemandMeters += demandMeter;
                    producedMeters += producedMeter;
                    
                    calculationDetails.push({
                        index: index + 1,
                        spec: item.spec,
                        area: item.area,
                        planned: item.planned,
                        produced: item.produced,
                        length: length,
                        demandMeter: demandMeter,
                        producedMeter: producedMeter
                    });
                } else {
                    // å¯¹äºå…¶ä½™æ•°æ®ï¼Œåªç´¯åŠ ä¸æ˜¾ç¤ºè¯¦æƒ…
                    const length = extractLengthFromSpec(item.spec);
                    totalDemandMeters += item.planned * length / 1000;
                    producedMeters += item.produced * length / 1000;
                }
            });

            html += '<table class="data-table">';
            html += '<thead><tr><th>åºå·</th><th>è§„æ ¼</th><th>åŒºåŸŸ</th><th>è®¡åˆ’(æ ¹)</th><th>å·²äº§(æ ¹)</th><th>é•¿åº¦(mm)</th><th>éœ€æ±‚(ç±³)</th><th>å·²äº§(ç±³)</th></tr></thead>';
            html += '<tbody>';
            
            calculationDetails.forEach(detail => {
                html += `
                    <tr>
                        <td>${detail.index}</td>
                        <td>${detail.spec}</td>
                        <td>${detail.area}</td>
                        <td>${detail.planned}</td>
                        <td>${detail.produced}</td>
                        <td>${detail.length}</td>
                        <td>${detail.demandMeter.toFixed(1)}</td>
                        <td>${detail.producedMeter.toFixed(1)}</td>
                    </tr>
                `;
            });
            
            if (data.length > 10) {
                html += `<tr><td colspan="8">... è¿˜æœ‰ ${data.length - 10} æ¡æ•°æ®</td></tr>`;
            }
            
            html += '</tbody></table>';
            
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h4>è®¡ç®—ç»“æœæ±‡æ€»</h4>
                    <p><strong>æ€»éœ€æ±‚é‡:</strong> ${totalDemandMeters.toFixed(1)} ç±³</p>
                    <p><strong>å·²ç”Ÿäº§é‡:</strong> ${producedMeters.toFixed(1)} ç±³</p>
                    <p><strong>å¾…ç”Ÿäº§é‡:</strong> ${(totalDemandMeters - producedMeters).toFixed(1)} ç±³</p>
                    <p><strong>å®Œæˆç‡:</strong> ${totalDemandMeters > 0 ? ((producedMeters / totalDemandMeters) * 100).toFixed(1) : 0}%</p>
                </div>
            `;

            analysisDiv.innerHTML = html;
            
            log(`è®¡ç®—å®Œæˆ - æ€»éœ€æ±‚: ${totalDemandMeters.toFixed(1)}ç±³, å·²ç”Ÿäº§: ${producedMeters.toFixed(1)}ç±³`, 'success');
        }

        // æå–è§„æ ¼ä¸­çš„é•¿åº¦ä¿¡æ¯
        function extractLengthFromSpec(spec) {
            if (!spec) return 0;
            
            // åŒ¹é…å„ç§é•¿åº¦æ ¼å¼
            const patterns = [
                /L=(\d+)/,           // L=6000
                /é•¿åº¦[ï¼š:]\s*(\d+)/,   // é•¿åº¦ï¼š6000
                /(\d+)mm/,           // 6000mm
                /(\d+)MM/,           // 6000MM
                /L(\d+)/,            // L6000
                /-(\d+)$/,           // è§„æ ¼-6000
                /Ã—(\d+)/,            // è§„æ ¼Ã—6000
                /\*(\d+)/,           // è§„æ ¼*6000
                /(\d{4,})/           // ç›´æ¥çš„4ä½ä»¥ä¸Šæ•°å­—
            ];
            
            for (const pattern of patterns) {
                const match = spec.match(pattern);
                if (match) {
                    const length = parseInt(match[1]);
                    if (length >= 1000 && length <= 20000) { // åˆç†çš„é•¿åº¦èŒƒå›´
                        return length;
                    }
                }
            }
            
            return 6000; // é»˜è®¤é•¿åº¦
        }

        // è¿è¡Œå®Œæ•´è°ƒè¯•
        function runFullDebug() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´è°ƒè¯•...', 'info');
            
            // 1. åˆ†ææ•°æ®æº
            log('1. åˆ†ææ•°æ®æº...', 'info');
            analyzeDataSources();
            
            // 2. åˆ·æ–°ç»Ÿè®¡
            log('2. åˆ·æ–°å½“å‰ç»Ÿè®¡...', 'info');
            refreshStats();
            
            // 3. åˆ†æè®¡ç®—è¿‡ç¨‹
            log('3. åˆ†æè®¡ç®—è¿‡ç¨‹...', 'info');
            setTimeout(() => {
                analyzeCalculation();
                log('å®Œæ•´è°ƒè¯•å®Œæˆ', 'success');
            }, 1000);
        }

        // å¼ºåˆ¶é‡æ–°è®¡ç®—
        function forceRecalculate() {
            log('å¼€å§‹å¼ºåˆ¶é‡æ–°è®¡ç®—...', 'warning');
            
            if (!window.dashboard) {
                log('âŒ Dashboardä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (!window.dataManager) {
                log('âŒ DataManagerä¸å­˜åœ¨', 'error');
                return;
            }
            
            // å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
            log('é‡æ–°åŠ è½½æœ¬åœ°æ•°æ®...', 'info');
            window.dataManager.loadFromLocalStorage();
            
            setTimeout(() => {
                // å¼ºåˆ¶é‡æ–°è®¡ç®—ç»Ÿè®¡
                log('å¼ºåˆ¶é‡æ–°è®¡ç®—ç»Ÿè®¡...', 'info');
                window.dashboard.updateMetricsFromDataManager();
                
                setTimeout(() => {
                    // å¼ºåˆ¶æ›´æ–°ç•Œé¢
                    log('å¼ºåˆ¶æ›´æ–°ç•Œé¢...', 'info');
                    window.dashboard.updateMetrics();
                    
                    setTimeout(() => {
                        refreshStats();
                        log('å¼ºåˆ¶é‡æ–°è®¡ç®—å®Œæˆ', 'success');
                    }, 500);
                }, 500);
            }, 500);
        }

        // é‡ç½®æ•°æ®
        function resetData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ•°æ®å—ï¼Ÿè¿™å°†é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ã€‚')) {
                log('å¼€å§‹é‡ç½®æ•°æ®...', 'warning');
                location.reload();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
            setTimeout(() => {
                runFullDebug();
            }, 1000);
        });
    </script>
</body>
</html>
