<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆæµ‹è¯• - ç»Ÿè®¡ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #333; }
        .btn.danger { background: #dc3545; }
        .result {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .metric {
            display: inline-block;
            background: #e9ecef;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            min-width: 140px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
        .status-good { color: #28a745; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>ğŸ¯ æœ€ç»ˆæµ‹è¯• - ç»Ÿè®¡ä¿®å¤éªŒè¯</h1>
        <p>è¿™æ˜¯æœ€ç»ˆçš„æµ‹è¯•å·¥å…·ï¼Œç”¨äºéªŒè¯ç»Ÿè®¡æ˜¾ç¤ºä¸º0çš„é—®é¢˜æ˜¯å¦å·²ç»è§£å†³ã€‚</p>
        
        <div style="margin: 20px 0;">
            <button class="btn success" onclick="runCompleteTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button class="btn warning" onclick="testMainPageFix()">ğŸ”§ æµ‹è¯•ä¸»é¡µä¿®å¤</button>
            <button class="btn" onclick="openMainPage()">ğŸ“Š æ‰“å¼€ä¸»é¡µ</button>
            <button class="btn danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>
    </div>

    <div class="test-card">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="testResults">
            <p>ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹éªŒè¯</p>
        </div>
    </div>

    <div class="test-card">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div id="testLog" class="log">
            <!-- æµ‹è¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('testLog');
            const color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logArea.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            document.getElementById('testResults').innerHTML = '<p>ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹éªŒè¯</p>';
            document.getElementById('testLog').innerHTML = '';
        }

        // æ‰“å¼€ä¸»é¡µ
        function openMainPage() {
            window.open('/', '_blank');
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        function runCompleteTest() {
            log('=== ğŸ¯ å¼€å§‹å®Œæ•´æµ‹è¯• ===', 'info');
            
            // 1. æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®
            log('1ï¸âƒ£ æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®...', 'info');
            const dataCheck = checkLocalStorageData();
            
            // 2. æµ‹è¯•è®¡ç®—é€»è¾‘
            log('2ï¸âƒ£ æµ‹è¯•è®¡ç®—é€»è¾‘...', 'info');
            const calcCheck = testCalculationLogic();
            
            // 3. æ¨¡æ‹Ÿä¸»é¡µé¢ä¿®å¤
            log('3ï¸âƒ£ æ¨¡æ‹Ÿä¸»é¡µé¢ä¿®å¤...', 'info');
            const fixCheck = simulateMainPageFix();
            
            // 4. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
            setTimeout(() => {
                generateTestReport(dataCheck, calcCheck, fixCheck);
                log('=== âœ… å®Œæ•´æµ‹è¯•å®Œæˆ ===', 'success');
            }, 1000);
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®
        function checkLocalStorageData() {
            const productionData = localStorage.getItem('productionData');
            
            if (!productionData) {
                log('âŒ æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ç”Ÿäº§æ•°æ®', 'error');
                return { status: 'error', message: 'æ²¡æœ‰ç”Ÿäº§æ•°æ®' };
            }

            try {
                const data = JSON.parse(productionData);
                log(`âœ… æœ¬åœ°å­˜å‚¨æ•°æ®æ­£å¸¸: ${data.length} æ¡è®°å½•`, 'success');
                
                // æ£€æŸ¥æ•°æ®æ ¼å¼
                if (data.length > 0) {
                    const sample = data[0];
                    const hasRequiredFields = sample.spec && sample.area && 
                                            (sample.planned !== undefined) && 
                                            (sample.produced !== undefined);
                    
                    if (hasRequiredFields) {
                        log('âœ… æ•°æ®æ ¼å¼éªŒè¯é€šè¿‡', 'success');
                        return { status: 'success', count: data.length, data: data };
                    } else {
                        log('âš ï¸ æ•°æ®æ ¼å¼å¯èƒ½æœ‰é—®é¢˜', 'warning');
                        return { status: 'warning', count: data.length, data: data };
                    }
                } else {
                    log('âš ï¸ æ•°æ®ä¸ºç©º', 'warning');
                    return { status: 'warning', count: 0 };
                }
            } catch (error) {
                log(`âŒ æ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
                return { status: 'error', message: error.message };
            }
        }

        // æµ‹è¯•è®¡ç®—é€»è¾‘
        function testCalculationLogic() {
            const dataCheck = checkLocalStorageData();
            
            if (dataCheck.status === 'error' || !dataCheck.data) {
                log('âŒ æ— æ³•æµ‹è¯•è®¡ç®—é€»è¾‘ï¼šæ•°æ®ä¸å¯ç”¨', 'error');
                return { status: 'error', message: 'æ•°æ®ä¸å¯ç”¨' };
            }

            try {
                const data = dataCheck.data;
                log(`å¼€å§‹æµ‹è¯• ${data.length} æ¡æ•°æ®çš„è®¡ç®—...`, 'info');

                // ä½¿ç”¨æ”¹è¿›çš„è§„æ ¼è§£æå‡½æ•°
                function extractLengthFromSpec(spec) {
                    if (!spec) return 6000;
                    
                    const patterns = [
                        /L=(\d+)/,
                        /é•¿åº¦[ï¼š:]\s*(\d+)/,
                        /(\d+)mm/i,
                        /(\d+)MM/,
                        /L(\d+)/,
                        /-(\d+)$/,
                        /Ã—(\d+)/,
                        /\*(\d+)/,
                        /(\d{4,})/
                    ];
                    
                    for (const pattern of patterns) {
                        const match = spec.match(pattern);
                        if (match) {
                            const length = parseInt(match[1]);
                            if (length >= 1000 && length <= 20000) {
                                return length;
                            }
                        }
                    }
                    
                    return 6000;
                }

                let totalDemandMeters = 0;
                let producedMeters = 0;
                let shippedMeters = 0;
                let validRecords = 0;

                data.forEach((item, index) => {
                    const length = extractLengthFromSpec(item.spec);
                    const planned = parseInt(item.planned) || 0;
                    const produced = parseInt(item.produced) || 0;
                    const shipped = parseInt(item.shipped) || 0;
                    
                    if (length > 0 && planned > 0) {
                        validRecords++;
                        totalDemandMeters += planned * length / 1000;
                        producedMeters += produced * length / 1000;
                        shippedMeters += shipped * length / 1000;
                    }

                    if (index < 3) {
                        log(`æ ·æœ¬${index + 1}: ${item.spec} -> ${length}mm, è®¡åˆ’${planned}æ ¹`, 'info');
                    }
                });

                const completionRate = totalDemandMeters > 0 ? 
                    ((producedMeters / totalDemandMeters) * 100).toFixed(1) : 0;

                log(`è®¡ç®—ç»“æœ: æ€»éœ€æ±‚${totalDemandMeters.toFixed(1)}ç±³, å·²äº§${producedMeters.toFixed(1)}ç±³`, 'success');
                log(`æœ‰æ•ˆè®°å½•: ${validRecords}/${data.length}, å®Œæˆç‡: ${completionRate}%`, 'success');

                if (totalDemandMeters > 0) {
                    log('âœ… è®¡ç®—é€»è¾‘æµ‹è¯•é€šè¿‡', 'success');
                    return {
                        status: 'success',
                        totalDemandMeters,
                        producedMeters,
                        shippedMeters,
                        completionRate,
                        validRecords,
                        totalRecords: data.length
                    };
                } else {
                    log('âŒ è®¡ç®—ç»“æœä¸º0ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜', 'error');
                    return { status: 'error', message: 'è®¡ç®—ç»“æœä¸º0' };
                }

            } catch (error) {
                log(`âŒ è®¡ç®—æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return { status: 'error', message: error.message };
            }
        }

        // æ¨¡æ‹Ÿä¸»é¡µé¢ä¿®å¤
        function simulateMainPageFix() {
            log('æ¨¡æ‹Ÿä¸»é¡µé¢çš„ä¿®å¤è¿‡ç¨‹...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®ä¸»é¡µé¢çš„å¯¹è±¡
            if (window.opener && window.opener.dashboard) {
                log('âœ… æ£€æµ‹åˆ°ä¸»é¡µé¢Dashboardå¯¹è±¡', 'success');
                
                try {
                    // å°è¯•è§¦å‘ä¿®å¤
                    log('å°è¯•è§¦å‘ä¸»é¡µé¢ä¿®å¤...', 'info');
                    window.opener.dashboard.quickSyncFix();
                    
                    setTimeout(() => {
                        const metrics = window.opener.dashboard.data?.totalDemandMeters || 0;
                        if (metrics > 0) {
                            log(`âœ… ä¸»é¡µé¢ä¿®å¤æˆåŠŸ: ${metrics.toFixed(1)}ç±³`, 'success');
                            return { status: 'success', metrics };
                        } else {
                            log('âš ï¸ ä¸»é¡µé¢ä¿®å¤åä»ä¸º0', 'warning');
                            return { status: 'warning', metrics: 0 };
                        }
                    }, 2000);
                    
                } catch (error) {
                    log(`âŒ ä¸»é¡µé¢ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                    return { status: 'error', message: error.message };
                }
            } else {
                log('âš ï¸ æ— æ³•è®¿é—®ä¸»é¡µé¢å¯¹è±¡ï¼Œå»ºè®®æ‰‹åŠ¨æµ‹è¯•', 'warning');
                return { status: 'warning', message: 'æ— æ³•è®¿é—®ä¸»é¡µé¢' };
            }
        }

        // æµ‹è¯•ä¸»é¡µä¿®å¤
        function testMainPageFix() {
            log('=== ğŸ”§ æµ‹è¯•ä¸»é¡µä¿®å¤åŠŸèƒ½ ===', 'info');
            
            // æ‰“å¼€ä¸»é¡µå¹¶ç­‰å¾…åŠ è½½
            const mainWindow = window.open('/', 'mainPage');
            
            log('ä¸»é¡µå·²æ‰“å¼€ï¼Œç­‰å¾…åŠ è½½å®Œæˆ...', 'info');
            
            setTimeout(() => {
                try {
                    if (mainWindow.dashboard) {
                        log('âœ… ä¸»é¡µDashboardå·²åŠ è½½', 'success');
                        log('è§¦å‘åŒæ­¥ä¿®å¤...', 'info');
                        
                        mainWindow.dashboard.quickSyncFix();
                        
                        setTimeout(() => {
                            const metrics = mainWindow.dashboard.data?.totalDemandMeters || 0;
                            log(`ä¿®å¤ç»“æœ: ${metrics.toFixed(1)}ç±³`, metrics > 0 ? 'success' : 'warning');
                            
                            if (metrics > 0) {
                                alert(`ä¿®å¤æˆåŠŸï¼æ€»éœ€æ±‚é‡: ${metrics.toFixed(1)}ç±³`);
                            } else {
                                alert('ä¿®å¤åä»æ˜¾ç¤º0ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
                            }
                        }, 3000);
                        
                    } else {
                        log('âŒ ä¸»é¡µDashboardæœªåŠ è½½', 'error');
                        alert('ä¸»é¡µDashboardæœªåŠ è½½ï¼Œè¯·ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå†è¯•');
                    }
                } catch (error) {
                    log(`âŒ è®¿é—®ä¸»é¡µå¤±è´¥: ${error.message}`, 'error');
                    alert('æ— æ³•è®¿é—®ä¸»é¡µï¼Œè¯·ç¡®ä¿ä¸»é¡µå·²æ­£ç¡®åŠ è½½');
                }
            }, 3000);
        }

        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        function generateTestReport(dataCheck, calcCheck, fixCheck) {
            const resultsDiv = document.getElementById('testResults');
            
            let html = '<h3>ğŸ¯ æµ‹è¯•æŠ¥å‘Š</h3>';
            
            // æ•°æ®æ£€æŸ¥ç»“æœ
            html += '<div class="result">';
            html += '<h4>1. æ•°æ®æ£€æŸ¥</h4>';
            if (dataCheck.status === 'success') {
                html += `<p class="status-good">âœ… é€šè¿‡ - å‘ç° ${dataCheck.count} æ¡æœ‰æ•ˆæ•°æ®</p>`;
            } else if (dataCheck.status === 'warning') {
                html += `<p class="status-warning">âš ï¸ è­¦å‘Š - ${dataCheck.message || 'æ•°æ®æ ¼å¼å¯èƒ½æœ‰é—®é¢˜'}</p>`;
            } else {
                html += `<p class="status-error">âŒ å¤±è´¥ - ${dataCheck.message}</p>`;
            }
            html += '</div>';
            
            // è®¡ç®—é€»è¾‘æµ‹è¯•ç»“æœ
            html += '<div class="result">';
            html += '<h4>2. è®¡ç®—é€»è¾‘æµ‹è¯•</h4>';
            if (calcCheck.status === 'success') {
                html += `<p class="status-good">âœ… é€šè¿‡ - è®¡ç®—é€»è¾‘æ­£å¸¸å·¥ä½œ</p>`;
                html += `
                    <div class="metric">
                        <div class="metric-value">${calcCheck.totalDemandMeters.toFixed(1)}</div>
                        <div class="metric-label">æ€»éœ€æ±‚é‡ (ç±³)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${calcCheck.producedMeters.toFixed(1)}</div>
                        <div class="metric-label">å·²ç”Ÿäº§é‡ (ç±³)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${calcCheck.completionRate}%</div>
                        <div class="metric-label">å®Œæˆç‡</div>
                    </div>
                `;
            } else {
                html += `<p class="status-error">âŒ å¤±è´¥ - ${calcCheck.message}</p>`;
            }
            html += '</div>';
            
            // æ€»ç»“
            html += '<div class="result">';
            html += '<h4>3. æµ‹è¯•æ€»ç»“</h4>';
            if (dataCheck.status === 'success' && calcCheck.status === 'success') {
                html += '<p class="status-good">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç»Ÿè®¡è®¡ç®—åŠŸèƒ½æ­£å¸¸ã€‚</p>';
                html += '<p><strong>å»ºè®®æ“ä½œï¼š</strong></p>';
                html += '<ul>';
                html += '<li>åœ¨ä¸»é¡µç‚¹å‡»"ğŸ”§ åŒæ­¥ä¿®å¤"æŒ‰é’®</li>';
                html += '<li>å¦‚æœä»æ˜¾ç¤º0ï¼Œç‚¹å‡»"ğŸ› è°ƒè¯•"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</li>';
                html += '<li>å¿…è¦æ—¶åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½</li>';
                html += '</ul>';
            } else {
                html += '<p class="status-error">âŒ æµ‹è¯•å‘ç°é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ’æŸ¥ã€‚</p>';
                html += '<p><strong>å»ºè®®æ“ä½œï¼š</strong></p>';
                html += '<ul>';
                html += '<li>æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®</li>';
                html += '<li>ç¡®è®¤è§„æ ¼å­—æ®µåŒ…å«é•¿åº¦ä¿¡æ¯</li>';
                html += '<li>è”ç³»æŠ€æœ¯æ”¯æŒè·å–å¸®åŠ©</li>';
                html += '</ul>';
            }
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('æœ€ç»ˆæµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            log('è¯·ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ', 'info');
        });
    </script>
</body>
</html>
