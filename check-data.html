<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ£€æŸ¥å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .check-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="check-card">
        <h1>ğŸ” æ•°æ®æ£€æŸ¥å·¥å…·</h1>
        <p>æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„å®é™…æ•°æ®æ ¼å¼å’Œå†…å®¹</p>
        <button class="btn success" onclick="checkAllData()">æ£€æŸ¥æ‰€æœ‰æ•°æ®</button>
        <button class="btn" onclick="checkProductionData()">æ£€æŸ¥ç”Ÿäº§æ•°æ®</button>
        <button class="btn" onclick="testCalculation()">æµ‹è¯•è®¡ç®—</button>
        <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="check-card">
        <h2>ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
        <div id="dataOverview">
            <!-- æ•°æ®æ¦‚è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div class="check-card">
        <h2>ğŸ“‹ æ•°æ®æ ·æœ¬</h2>
        <div id="dataSample">
            <!-- æ•°æ®æ ·æœ¬å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div class="check-card">
        <h2>ğŸ“ æ£€æŸ¥æ—¥å¿—</h2>
        <div id="checkLog" class="log">
            <!-- æ£€æŸ¥æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('checkLog');
            const color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logArea.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('checkLog').innerHTML = '';
        }

        // æ£€æŸ¥æ‰€æœ‰æ•°æ®
        function checkAllData() {
            log('=== å¼€å§‹æ£€æŸ¥æ‰€æœ‰æ•°æ® ===', 'info');
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            checkLocalStorage();
            
            // æ£€æŸ¥ç”Ÿäº§æ•°æ®
            checkProductionData();
            
            // æ£€æŸ¥å‘è´§æ•°æ®
            checkShippingData();
            
            // æ£€æŸ¥åŸææ–™æ•°æ®
            checkMaterialData();
            
            // æ›´æ–°æ¦‚è§ˆ
            updateDataOverview();
            
            log('=== æ•°æ®æ£€æŸ¥å®Œæˆ ===', 'success');
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
        function checkLocalStorage() {
            log('æ£€æŸ¥æœ¬åœ°å­˜å‚¨...', 'info');
            
            const keys = ['productionData', 'shippingHistory', 'materialPurchases'];
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`âœ… ${key}: ${Array.isArray(parsed) ? parsed.length : 'N/A'} æ¡è®°å½•`, 'success');
                    } catch (error) {
                        log(`âŒ ${key}: è§£æå¤±è´¥ - ${error.message}`, 'error');
                    }
                } else {
                    log(`âš ï¸ ${key}: ä¸å­˜åœ¨`, 'warning');
                }
            });
        }

        // æ£€æŸ¥ç”Ÿäº§æ•°æ®
        function checkProductionData() {
            log('æ£€æŸ¥ç”Ÿäº§æ•°æ®è¯¦æƒ…...', 'info');
            
            const data = localStorage.getItem('productionData');
            if (!data) {
                log('âŒ ç”Ÿäº§æ•°æ®ä¸å­˜åœ¨', 'error');
                return;
            }

            try {
                const productionData = JSON.parse(data);
                log(`ğŸ“Š ç”Ÿäº§æ•°æ®æ€»æ•°: ${productionData.length} æ¡`, 'info');
                
                if (productionData.length === 0) {
                    log('âš ï¸ ç”Ÿäº§æ•°æ®ä¸ºç©º', 'warning');
                    return;
                }

                // åˆ†ææ•°æ®ç»“æ„
                const firstItem = productionData[0];
                log('ğŸ“‹ æ•°æ®ç»“æ„åˆ†æ:', 'info');
                log(`  å­—æ®µ: ${Object.keys(firstItem).join(', ')}`, 'info');
                
                // æ£€æŸ¥å…³é”®å­—æ®µ
                const requiredFields = ['spec', 'area', 'planned', 'produced'];
                const missingFields = requiredFields.filter(field => !(field in firstItem));
                if (missingFields.length > 0) {
                    log(`âŒ ç¼ºå°‘å…³é”®å­—æ®µ: ${missingFields.join(', ')}`, 'error');
                } else {
                    log('âœ… å…³é”®å­—æ®µå®Œæ•´', 'success');
                }

                // åˆ†æè§„æ ¼æ ¼å¼
                log('ğŸ” è§„æ ¼æ ¼å¼åˆ†æ:', 'info');
                const specs = productionData.slice(0, 10).map(item => item.spec).filter(spec => spec);
                specs.forEach((spec, index) => {
                    log(`  ${index + 1}. "${spec}"`, 'info');
                });

                // ç»Ÿè®¡æ•°æ®
                const totalPlanned = productionData.reduce((sum, item) => sum + (item.planned || 0), 0);
                const totalProduced = productionData.reduce((sum, item) => sum + (item.produced || 0), 0);
                const totalShipped = productionData.reduce((sum, item) => sum + (item.shipped || 0), 0);
                
                log('ğŸ“ˆ æ•°æ®ç»Ÿè®¡:', 'info');
                log(`  æ€»è®¡åˆ’é‡: ${totalPlanned} æ ¹`, 'info');
                log(`  æ€»ç”Ÿäº§é‡: ${totalProduced} æ ¹`, 'info');
                log(`  æ€»å‘è´§é‡: ${totalShipped} æ ¹`, 'info');

                // æ˜¾ç¤ºæ•°æ®æ ·æœ¬
                displayDataSample(productionData.slice(0, 5));

            } catch (error) {
                log(`âŒ ç”Ÿäº§æ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥å‘è´§æ•°æ®
        function checkShippingData() {
            log('æ£€æŸ¥å‘è´§æ•°æ®...', 'info');
            
            const data = localStorage.getItem('shippingHistory');
            if (!data) {
                log('âš ï¸ å‘è´§æ•°æ®ä¸å­˜åœ¨', 'warning');
                return;
            }

            try {
                const shippingData = JSON.parse(data);
                log(`ğŸ“¦ å‘è´§æ•°æ®æ€»æ•°: ${shippingData.length} æ¡`, 'info');
            } catch (error) {
                log(`âŒ å‘è´§æ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥åŸææ–™æ•°æ®
        function checkMaterialData() {
            log('æ£€æŸ¥åŸææ–™æ•°æ®...', 'info');
            
            const data = localStorage.getItem('materialPurchases');
            if (!data) {
                log('âš ï¸ åŸææ–™æ•°æ®ä¸å­˜åœ¨', 'warning');
                return;
            }

            try {
                const materialData = JSON.parse(data);
                log(`ğŸ­ åŸææ–™æ•°æ®æ€»æ•°: ${materialData.length} æ¡`, 'info');
            } catch (error) {
                log(`âŒ åŸææ–™æ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºæ•°æ®æ ·æœ¬
        function displayDataSample(sampleData) {
            const sampleDiv = document.getElementById('dataSample');
            
            if (!sampleData || sampleData.length === 0) {
                sampleDiv.innerHTML = '<p>æ²¡æœ‰æ•°æ®æ ·æœ¬</p>';
                return;
            }

            let html = '<table class="data-table">';
            html += '<thead><tr>';
            
            // è¡¨å¤´
            const fields = Object.keys(sampleData[0]);
            fields.forEach(field => {
                html += `<th>${field}</th>`;
            });
            html += '</tr></thead><tbody>';

            // æ•°æ®è¡Œ
            sampleData.forEach(item => {
                html += '<tr>';
                fields.forEach(field => {
                    const value = item[field];
                    html += `<td>${value !== null && value !== undefined ? value : ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            sampleDiv.innerHTML = html;
        }

        // æ›´æ–°æ•°æ®æ¦‚è§ˆ
        function updateDataOverview() {
            const overviewDiv = document.getElementById('dataOverview');
            
            const productionData = localStorage.getItem('productionData');
            const shippingData = localStorage.getItem('shippingHistory');
            const materialData = localStorage.getItem('materialPurchases');

            let html = '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';

            // ç”Ÿäº§æ•°æ®æ¦‚è§ˆ
            if (productionData) {
                try {
                    const data = JSON.parse(productionData);
                    const status = data.length > 0 ? 'good' : 'warning';
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                            <h4>ç”Ÿäº§æ•°æ®</h4>
                            <p class="status-${status}">${data.length} æ¡è®°å½•</p>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                            <h4>ç”Ÿäº§æ•°æ®</h4>
                            <p class="status-error">è§£æé”™è¯¯</p>
                        </div>
                    `;
                }
            } else {
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                        <h4>ç”Ÿäº§æ•°æ®</h4>
                        <p class="status-error">ä¸å­˜åœ¨</p>
                    </div>
                `;
            }

            // å‘è´§æ•°æ®æ¦‚è§ˆ
            if (shippingData) {
                try {
                    const data = JSON.parse(shippingData);
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                            <h4>å‘è´§æ•°æ®</h4>
                            <p class="status-good">${data.length} æ¡è®°å½•</p>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                            <h4>å‘è´§æ•°æ®</h4>
                            <p class="status-error">è§£æé”™è¯¯</p>
                        </div>
                    `;
                }
            } else {
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                        <h4>å‘è´§æ•°æ®</h4>
                        <p class="status-warning">ä¸å­˜åœ¨</p>
                    </div>
                `;
            }

            // åŸææ–™æ•°æ®æ¦‚è§ˆ
            if (materialData) {
                try {
                    const data = JSON.parse(materialData);
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                            <h4>åŸææ–™æ•°æ®</h4>
                            <p class="status-good">${data.length} æ¡è®°å½•</p>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                            <h4>åŸææ–™æ•°æ®</h4>
                            <p class="status-error">è§£æé”™è¯¯</p>
                        </div>
                    `;
                }
            } else {
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; min-width: 150px;">
                        <h4>åŸææ–™æ•°æ®</h4>
                        <p class="status-warning">ä¸å­˜åœ¨</p>
                    </div>
                `;
            }

            html += '</div>';
            overviewDiv.innerHTML = html;
        }

        // æµ‹è¯•è®¡ç®—
        function testCalculation() {
            log('=== æµ‹è¯•ç»Ÿè®¡è®¡ç®— ===', 'info');
            
            const data = localStorage.getItem('productionData');
            if (!data) {
                log('âŒ æ²¡æœ‰ç”Ÿäº§æ•°æ®å¯ä¾›æµ‹è¯•', 'error');
                return;
            }

            try {
                const productionData = JSON.parse(data);
                log(`å¼€å§‹æµ‹è¯• ${productionData.length} æ¡æ•°æ®çš„è®¡ç®—...`, 'info');

                // ä½¿ç”¨æ”¹è¿›çš„è§„æ ¼è§£æå‡½æ•°
                function extractLengthFromSpec(spec) {
                    if (!spec) return 6000;
                    
                    const patterns = [
                        /L=(\d+)/,
                        /é•¿åº¦[ï¼š:]\s*(\d+)/,
                        /(\d+)mm/i,
                        /(\d+)MM/,
                        /L(\d+)/,
                        /-(\d+)$/,
                        /Ã—(\d+)/,
                        /\*(\d+)/,
                        /(\d{4,})/
                    ];
                    
                    for (const pattern of patterns) {
                        const match = spec.match(pattern);
                        if (match) {
                            const length = parseInt(match[1]);
                            if (length >= 1000 && length <= 20000) {
                                return length;
                            }
                        }
                    }
                    
                    return 6000;
                }

                let totalDemandMeters = 0;
                let producedMeters = 0;
                let shippedMeters = 0;
                let validRecords = 0;
                let invalidRecords = 0;

                // æµ‹è¯•å‰5æ¡æ•°æ®çš„è¯¦ç»†è®¡ç®—
                log('è¯¦ç»†è®¡ç®—è¿‡ç¨‹ (å‰5æ¡):', 'info');
                productionData.slice(0, 5).forEach((item, index) => {
                    const length = extractLengthFromSpec(item.spec);
                    const planned = item.planned || 0;
                    const produced = item.produced || 0;
                    const shipped = item.shipped || 0;
                    
                    const demandMeter = planned * length / 1000;
                    const producedMeter = produced * length / 1000;
                    const shippedMeter = shipped * length / 1000;

                    log(`ç¬¬${index + 1}æ¡: ${item.spec}`, 'info');
                    log(`  è§£æé•¿åº¦: ${length}mm`, 'info');
                    log(`  éœ€æ±‚: ${planned}æ ¹ Ã— ${length}mm Ã· 1000 = ${demandMeter.toFixed(1)}ç±³`, 'info');
                    log(`  å·²äº§: ${produced}æ ¹ Ã— ${length}mm Ã· 1000 = ${producedMeter.toFixed(1)}ç±³`, 'info');
                    log(`  å·²å‘: ${shipped}æ ¹ Ã— ${length}mm Ã· 1000 = ${shippedMeter.toFixed(1)}ç±³`, 'info');
                });

                // è®¡ç®—æ‰€æœ‰æ•°æ®
                productionData.forEach(item => {
                    const length = extractLengthFromSpec(item.spec);
                    const planned = item.planned || 0;
                    const produced = item.produced || 0;
                    const shipped = item.shipped || 0;
                    
                    if (length > 0 && planned > 0) {
                        validRecords++;
                        totalDemandMeters += planned * length / 1000;
                        producedMeters += produced * length / 1000;
                        shippedMeters += shipped * length / 1000;
                    } else {
                        invalidRecords++;
                    }
                });

                const pendingMeters = totalDemandMeters - producedMeters;
                const completionRate = totalDemandMeters > 0 ? ((producedMeters / totalDemandMeters) * 100).toFixed(1) : 0;

                log('=== è®¡ç®—ç»“æœ ===', 'success');
                log(`æœ‰æ•ˆè®°å½•: ${validRecords} æ¡`, 'info');
                log(`æ— æ•ˆè®°å½•: ${invalidRecords} æ¡`, 'warning');
                log(`æ€»éœ€æ±‚é‡: ${totalDemandMeters.toFixed(1)} ç±³`, 'success');
                log(`å·²ç”Ÿäº§é‡: ${producedMeters.toFixed(1)} ç±³`, 'success');
                log(`å¾…ç”Ÿäº§é‡: ${pendingMeters.toFixed(1)} ç±³`, 'success');
                log(`å·²å‘è´§é‡: ${shippedMeters.toFixed(1)} ç±³`, 'success');
                log(`å®Œæˆç‡: ${completionRate}%`, 'success');

                if (totalDemandMeters === 0) {
                    log('âš ï¸ è®¡ç®—ç»“æœä¸º0ï¼Œå¯èƒ½çš„åŸå› :', 'warning');
                    log('  1. è§„æ ¼æ ¼å¼æ— æ³•è¯†åˆ«', 'warning');
                    log('  2. è®¡åˆ’æ•°é‡ä¸º0æˆ–ç©º', 'warning');
                    log('  3. æ•°æ®ç»“æ„å¼‚å¸¸', 'warning');
                }

            } catch (error) {
                log(`âŒ è®¡ç®—æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('æ•°æ®æ£€æŸ¥å·¥å…·å·²åŠ è½½', 'success');
            setTimeout(() => {
                checkAllData();
            }, 500);
        });
    </script>
</body>
</html>
