<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase APIå¯†é’¥ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .step {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .step h3 {
            color: #3b82f6;
            margin-top: 0;
        }
        .config-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            min-height: 150px;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .code-output {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .instructions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .instructions h4 {
            color: #92400e;
            margin-top: 0;
        }
        .instructions ol {
            color: #92400e;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ Firebase APIå¯†é’¥ä¿®å¤å·¥å…·</h1>
        
        <div class="alert alert-error">
            <strong>æ£€æµ‹åˆ°é—®é¢˜ï¼š</strong> APIå¯†é’¥æ— æ•ˆ (auth/api-key-not-valid)
            <br>éœ€è¦ä»Firebaseæ§åˆ¶å°è·å–æ–°çš„é…ç½®æ¥ä¿®å¤æ­¤é—®é¢˜ã€‚
        </div>

        <div class="step">
            <h3>æ­¥éª¤1ï¼šè·å–æ–°çš„Firebaseé…ç½®</h3>
            <div class="instructions">
                <h4>ğŸ“‹ æ“ä½œæŒ‡å—ï¼š</h4>
                <ol>
                    <li>è®¿é—® <a href="https://console.firebase.google.com/" target="_blank">Firebaseæ§åˆ¶å°</a></li>
                    <li>é€‰æ‹©é¡¹ç›® <strong>zhlscglxt</strong></li>
                    <li>ç‚¹å‡»é¡¹ç›®è®¾ç½®ï¼ˆé½¿è½®å›¾æ ‡ï¼‰</li>
                    <li>é€‰æ‹©"é¡¹ç›®è®¾ç½®"</li>
                    <li>æ»šåŠ¨åˆ°"æ‚¨çš„åº”ç”¨"éƒ¨åˆ†</li>
                    <li>ç‚¹å‡»Webåº”ç”¨çš„é…ç½®å›¾æ ‡ <code>&lt;/&gt;</code></li>
                    <li>å¤åˆ¶å®Œæ•´çš„é…ç½®å¯¹è±¡</li>
                </ol>
            </div>
            <button class="btn" onclick="openFirebaseConsole()">æ‰“å¼€Firebaseæ§åˆ¶å°</button>
        </div>

        <div class="step">
            <h3>æ­¥éª¤2ï¼šç²˜è´´æ–°é…ç½®</h3>
            <p>å°†ä»Firebaseæ§åˆ¶å°å¤åˆ¶çš„é…ç½®ç²˜è´´åˆ°ä¸‹é¢çš„æ–‡æœ¬æ¡†ä¸­ï¼š</p>
            <textarea class="config-input" id="newConfig" placeholder="è¯·ç²˜è´´å®Œæ•´çš„Firebaseé…ç½®ï¼Œä¾‹å¦‚ï¼š

const firebaseConfig = {
  apiKey: &quot;your-new-api-key&quot;,
  authDomain: &quot;zhlscglxt.firebaseapp.com&quot;,
  projectId: &quot;zhlscglxt&quot;,
  storageBucket: &quot;zhlscglxt.firebasestorage.app&quot;,
  messagingSenderId: &quot;36495989654&quot;,
  appId: &quot;1:36495989654:web:your-new-app-id&quot;
};

æˆ–è€…JSONæ ¼å¼ï¼š
{
  &quot;apiKey&quot;: &quot;your-new-api-key&quot;,
  &quot;authDomain&quot;: &quot;zhlscglxt.firebaseapp.com&quot;,
  &quot;projectId&quot;: &quot;zhlscglxt&quot;,
  &quot;storageBucket&quot;: &quot;zhlscglxt.firebasestorage.app&quot;,
  &quot;messagingSenderId&quot;: &quot;36495989654&quot;,
  &quot;appId&quot;: &quot;1:36495989654:web:your-new-app-id&quot;
}"></textarea>
            <button class="btn" onclick="validateNewConfig()">éªŒè¯é…ç½®</button>
            <button class="btn btn-success" onclick="testNewConfig()">æµ‹è¯•æ–°é…ç½®</button>
        </div>

        <div class="step">
            <h3>æ­¥éª¤3ï¼šç”Ÿæˆä¿®å¤ä»£ç </h3>
            <p>éªŒè¯æˆåŠŸåï¼Œç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®ç”Ÿæˆä¿®å¤ä»£ç ï¼š</p>
            <button class="btn btn-success" onclick="generateFixCode()">ç”Ÿæˆä¿®å¤ä»£ç </button>
            <button class="btn btn-danger" onclick="downloadFixedFiles()">ä¸‹è½½ä¿®å¤æ–‡ä»¶</button>
            
            <div id="fixedCode" style="display: none;">
                <h4>ä¿®å¤ä»£ç ï¼š</h4>
                <div class="code-output" id="codeOutput"></div>
                <div class="instructions">
                    <h4>ğŸ”§ åº”ç”¨ä¿®å¤ï¼š</h4>
                    <ol>
                        <li>å¤åˆ¶ä¸Šé¢çš„ä»£ç </li>
                        <li>æ‰“å¼€ <code>index.html</code> æ–‡ä»¶</li>
                        <li>æ‰¾åˆ°ç¬¬1672-1679è¡Œçš„Firebaseé…ç½®</li>
                        <li>æ›¿æ¢ä¸ºæ–°çš„é…ç½®</li>
                        <li>ä¿å­˜æ–‡ä»¶å¹¶åˆ·æ–°é¡µé¢</li>
                    </ol>
                </div>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let validatedConfig = null;

        function showResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function openFirebaseConsole() {
            window.open('https://console.firebase.google.com/project/zhlscglxt/settings/general/', '_blank');
        }

        function validateNewConfig() {
            const configText = document.getElementById('newConfig').value.trim();
            
            if (!configText) {
                showResult('âŒ è¯·è¾“å…¥Firebaseé…ç½®', 'error');
                return;
            }

            try {
                let config;
                
                // å°è¯•è§£æä¸åŒæ ¼å¼çš„é…ç½®
                if (configText.includes('const firebaseConfig')) {
                    // JavaScriptæ ¼å¼
                    const match = configText.match(/const firebaseConfig\s*=\s*({[\s\S]*?});/);
                    if (match) {
                        config = eval('(' + match[1] + ')');
                    } else {
                        throw new Error('æ— æ³•è§£æJavaScripté…ç½®æ ¼å¼');
                    }
                } else if (configText.startsWith('{')) {
                    // JSONæ ¼å¼
                    config = JSON.parse(configText);
                } else {
                    // å°è¯•ç›´æ¥è§£æä¸ºJavaScriptå¯¹è±¡
                    config = eval('(' + configText + ')');
                }

                // éªŒè¯å¿…éœ€çš„å­—æ®µ
                const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                const missingFields = requiredFields.filter(field => !config[field]);

                if (missingFields.length > 0) {
                    showResult(`âŒ é…ç½®ç¼ºå°‘å¿…éœ€å­—æ®µ: ${missingFields.join(', ')}`, 'error');
                    return;
                }

                // éªŒè¯é¡¹ç›®IDæ˜¯å¦åŒ¹é…
                if (config.projectId !== 'zhlscglxt') {
                    showResult(`âš ï¸ è­¦å‘Šï¼šé¡¹ç›®IDä¸åŒ¹é…ã€‚å½“å‰: ${config.projectId}ï¼ŒæœŸæœ›: zhlscglxt`, 'error');
                    return;
                }

                validatedConfig = config;
                showResult('âœ… é…ç½®éªŒè¯æˆåŠŸï¼', 'success');
                showResult(`é¡¹ç›®ID: ${config.projectId}`, 'info');
                showResult(`æ–°APIå¯†é’¥: ${config.apiKey.substring(0, 20)}...`, 'info');

            } catch (error) {
                showResult(`âŒ é…ç½®æ ¼å¼é”™è¯¯: ${error.message}`, 'error');
                showResult('ğŸ’¡ è¯·ç¡®ä¿ç²˜è´´å®Œæ•´çš„é…ç½®å¯¹è±¡', 'info');
            }
        }

        async function testNewConfig() {
            if (!validatedConfig) {
                showResult('âŒ è¯·å…ˆéªŒè¯é…ç½®', 'error');
                return;
            }

            showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•æ–°é…ç½®...', 'info');

            try {
                // åŠ¨æ€åŠ è½½Firebase SDKå¹¶æµ‹è¯•
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const { getFirestore, collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

                const testApp = initializeApp(validatedConfig, 'test-app');
                const testAuth = getAuth(testApp);
                const testDB = getFirestore(testApp);

                // å…ˆæµ‹è¯•åŸºæœ¬è¿æ¥
                showResult('ğŸ”„ æµ‹è¯•åŸºæœ¬è¿æ¥...', 'info');

                try {
                    await signInAnonymously(testAuth);
                    showResult('âœ… æ–°é…ç½®æµ‹è¯•æˆåŠŸï¼APIå¯†é’¥æœ‰æ•ˆ', 'success');
                    showResult(`âœ… åŒ¿åç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID: ${testAuth.currentUser.uid}`, 'success');

                    // æµ‹è¯•æ•°æ®åº“è¿æ¥
                    showResult('ğŸ”„ æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
                    const testDocRef = doc(collection(testDB, 'test'), 'connection');
                    await getDoc(testDocRef);
                    showResult('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');

                } catch (authError) {
                    if (authError.code === 'auth/admin-restricted-operation') {
                        showResult('âš ï¸ æ£€æµ‹åˆ°ç®¡ç†å‘˜é™åˆ¶é”™è¯¯', 'error');
                        showResult('ğŸ”§ æ­£åœ¨æä¾›è§£å†³æ–¹æ¡ˆ...', 'info');
                        showAdminRestrictedSolution();
                    } else {
                        throw authError;
                    }
                }

            } catch (error) {
                showResult(`âŒ æ–°é…ç½®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');

                if (error.message.includes('api-key-not-valid')) {
                    showResult('ğŸ’¡ APIå¯†é’¥ä»ç„¶æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¤åˆ¶äº†æ­£ç¡®çš„é…ç½®', 'error');
                } else if (error.message.includes('auth/domain-not-authorized')) {
                    showResult('ğŸ’¡ åŸŸåæœªæˆæƒï¼Œè¯·åœ¨Firebaseæ§åˆ¶å°æ·»åŠ å½“å‰åŸŸååˆ°æˆæƒåŸŸååˆ—è¡¨', 'error');
                } else if (error.code === 'auth/admin-restricted-operation') {
                    showAdminRestrictedSolution();
                }
            }
        }

        function showAdminRestrictedSolution() {
            const solutionHTML = `
                <div class="alert alert-error">
                    <strong>ğŸš¨ æ£€æµ‹åˆ°é—®é¢˜ï¼š</strong> Firebaseé¡¹ç›®è®¾ç½®äº†ç®¡ç†å‘˜é™åˆ¶ (auth/admin-restricted-operation)
                </div>
                <div class="instructions">
                    <h4>ğŸ”§ è§£å†³æ–¹æ¡ˆï¼šå¯ç”¨åŒ¿åç™»å½•</h4>
                    <ol>
                        <li>è®¿é—® <a href="https://console.firebase.google.com/project/zhlscglxt/authentication/providers" target="_blank">Firebaseèº«ä»½éªŒè¯è®¾ç½®</a></li>
                        <li>åœ¨"ç™»å½•æ–¹æ³•"æ ‡ç­¾é¡µä¸­æ‰¾åˆ°"åŒ¿å"é€‰é¡¹</li>
                        <li>ç‚¹å‡»"åŒ¿å"è¡Œï¼Œç„¶åç‚¹å‡»"å¯ç”¨"å¼€å…³</li>
                        <li>ç‚¹å‡»"ä¿å­˜"æŒ‰é’®</li>
                        <li>è¿”å›æ­¤é¡µé¢ï¼Œé‡æ–°ç‚¹å‡»"æµ‹è¯•æ–°é…ç½®"</li>
                    </ol>
                    <p><strong>æˆ–è€…ï¼Œä½¿ç”¨ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š</strong></p>
                    <button class="btn btn-success" onclick="generateNoAuthConfig()">ç”Ÿæˆæ— éœ€è®¤è¯çš„é…ç½®</button>
                    <button class="btn" onclick="window.open('https://console.firebase.google.com/project/zhlscglxt/authentication/providers', '_blank')">æ‰“å¼€èº«ä»½éªŒè¯è®¾ç½®</button>
                </div>
            `;

            showResult(solutionHTML, 'error');
        }

        function generateNoAuthConfig() {
            if (!validatedConfig) {
                showResult('âŒ è¯·å…ˆéªŒè¯é…ç½®', 'error');
                return;
            }

            showResult('ğŸ”„ ç”Ÿæˆæ— éœ€è®¤è¯çš„é…ç½®...', 'info');

            // ç”Ÿæˆä¿®æ”¹åçš„FirebaseåŒæ­¥è„šæœ¬ï¼Œè·³è¿‡è®¤è¯æ­¥éª¤
            const noAuthSyncCode = `// ä¿®æ”¹åçš„FirebaseåŒæ­¥ç®¡ç†å™¨ - æ— éœ€è®¤è¯ç‰ˆæœ¬
// å°†æ­¤ä»£ç æ›¿æ¢åˆ° scripts/firebase-sync.js æ–‡ä»¶ä¸­çš„ initialize æ–¹æ³•

async initialize(config) {
    try {
        console.log('å¼€å§‹åˆå§‹åŒ–Firebaseï¼ˆæ— è®¤è¯æ¨¡å¼ï¼‰ï¼Œé…ç½®:', config);

        // ç­‰å¾…Firebase SDKåŠ è½½
        let retries = 0;
        while (!window.firebaseDB && retries < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }

        if (!window.firebaseDB) {
            throw new Error('Firebase SDK æœªåŠ è½½ï¼Œè¯·ç¡®ä¿å·²å¼•å…¥ Firebase è„šæœ¬');
        }

        console.log('Firebase SDK v10å·²åŠ è½½');

        // ä½¿ç”¨å…¨å±€Firebaseå®ä¾‹
        this.db = window.firebaseDB;
        this.auth = window.firebaseAuth;
        console.log('FirebaseæœåŠ¡è·å–æˆåŠŸ');

        // è·³è¿‡è®¤è¯ï¼Œç›´æ¥è®¾ç½®ä¸ºå·²åˆå§‹åŒ–
        this.isInitialized = true;
        this.currentUser = { uid: 'anonymous_' + Date.now() }; // æ¨¡æ‹Ÿç”¨æˆ·
        console.log('âœ… Firebase åˆå§‹åŒ–å®Œæˆï¼ˆæ— è®¤è¯æ¨¡å¼ï¼‰');

        // å¼€å§‹ç›‘å¬æ•°æ®å˜åŒ–ï¼ˆä»…è¯»å–ï¼Œä¸å†™å…¥ï¼‰
        this.startRealtimeSync();

        return true;
    } catch (error) {
        console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
        this.showNotification('äº‘ç«¯åŒæ­¥åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨', 'warning');
        return false;
    }
}`;

            document.getElementById('codeOutput').textContent = noAuthSyncCode;
            document.getElementById('fixedCode').style.display = 'block';

            showResult('âœ… æ— éœ€è®¤è¯çš„é…ç½®å·²ç”Ÿæˆï¼', 'success');
            showResult('ğŸ“‹ ä»£ç å·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼Œè¯·æŒ‰è¯´æ˜åº”ç”¨', 'info');
            showResult('âš ï¸ æ³¨æ„ï¼šæ­¤æ¨¡å¼ä¸‹åªèƒ½è¯»å–æ•°æ®ï¼Œæ— æ³•å†™å…¥äº‘ç«¯', 'error');
        }

        function generateFixCode() {
            if (!validatedConfig) {
                showResult('âŒ è¯·å…ˆéªŒè¯é…ç½®', 'error');
                return;
            }

            const fixedConfigCode = `        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "${validatedConfig.apiKey}",
            authDomain: "${validatedConfig.authDomain}",
            projectId: "${validatedConfig.projectId}",
            storageBucket: "${validatedConfig.storageBucket}",
            messagingSenderId: "${validatedConfig.messagingSenderId}",
            appId: "${validatedConfig.appId}"
        };`;

            document.getElementById('codeOutput').textContent = fixedConfigCode;
            document.getElementById('fixedCode').style.display = 'block';
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(fixedConfigCode).then(() => {
                showResult('ğŸ“‹ ä¿®å¤ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });

            showResult('âœ… ä¿®å¤ä»£ç å·²ç”Ÿæˆï¼', 'success');
        }

        function downloadFixedFiles() {
            if (!validatedConfig) {
                showResult('âŒ è¯·å…ˆéªŒè¯é…ç½®', 'error');
                return;
            }

            const instructions = `Firebase APIå¯†é’¥ä¿®å¤è¯´æ˜
============================

é—®é¢˜ï¼šAPIå¯†é’¥æ— æ•ˆ (auth/api-key-not-valid)
è§£å†³æ–¹æ¡ˆï¼šæ›´æ–°Firebaseé…ç½®

ä¿®å¤æ­¥éª¤ï¼š
1. æ‰“å¼€ index.html æ–‡ä»¶
2. æ‰¾åˆ°ç¬¬1672-1679è¡Œçš„Firebaseé…ç½®éƒ¨åˆ†
3. å°†ä»¥ä¸‹ä»£ç æ›¿æ¢åŸæœ‰é…ç½®ï¼š

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "${validatedConfig.apiKey}",
            authDomain: "${validatedConfig.authDomain}",
            projectId: "${validatedConfig.projectId}",
            storageBucket: "${validatedConfig.storageBucket}",
            messagingSenderId: "${validatedConfig.messagingSenderId}",
            appId: "${validatedConfig.appId}"
        };

4. ä¿å­˜æ–‡ä»¶
5. åˆ·æ–°æµè§ˆå™¨é¡µé¢
6. æ£€æŸ¥Firebaseè¿æ¥çŠ¶æ€

ä¿®å¤å®Œæˆåï¼Œç³»ç»Ÿåº”è¯¥æ˜¾ç¤ºï¼š
- âœ… Firebaseè¿æ¥çŠ¶æ€ï¼šå·²è¿æ¥
- âœ… å®æ—¶åŒæ­¥åŠŸèƒ½æ­£å¸¸
- âœ… å¤šç”¨æˆ·åä½œåŠŸèƒ½å¯ç”¨

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è¿è¡Œ firebase-diagnostic.html è¿›è¡Œè¿›ä¸€æ­¥è¯Šæ–­ã€‚
`;

            const blob = new Blob([instructions], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'firebase-api-key-fix-instructions.txt';
            a.click();
            URL.revokeObjectURL(url);

            showResult('ğŸ“ ä¿®å¤è¯´æ˜æ–‡ä»¶å·²ä¸‹è½½', 'success');
        }
    </script>
</body>
</html>
